 <!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clicker v2</title>
<style>
  :root{
    --bg:#f7f8fb; --card:#ffffff; --accent:#6c63ff; --muted:#7b7f8b;
    --success:#28a745;
  }
  body{
    margin:0; font-family: Inter, Roboto, Arial, sans-serif;
    background: linear-gradient(180deg,#f7f8fb 0%, #eef2ff 100%);
    color:#222; min-height:100vh; display:flex; align-items:center; justify-content:center;
  }
  .wrap{width:min(720px,96%); background:var(--card); border-radius:14px; box-shadow:0 10px 30px rgba(20,20,40,0.08); padding:20px; }
  header{display:flex; gap:12px; align-items:center; margin-bottom:12px;}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#9f9aff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px}
  h1{margin:0;font-size:18px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{flex:1; padding:14px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfdff); box-shadow:inset 0 -1px 0 rgba(12,15,30,0.02)}
  .score{font-size:48px;font-weight:700; color:var(--accent); text-align:center; margin:8px 0}
  .btn{display:inline-block;padding:12px 18px;background:var(--accent);color:white;border-radius:10px;border:0;font-weight:700;cursor:pointer;box-shadow:0 6px 14px rgba(108,99,255,0.18)}
  .btn:active{transform:translateY(1px)}
  .muted{color:var(--muted); font-size:13px}
  .shop-item{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding:10px;border-radius:8px;background:#f8f9ff}
  .small{font-size:13px}
  footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  .secondary{background:#eef0ff;color:var(--accent); padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; border:0}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#1b1b1f;color:white;padding:8px 14px;border-radius:10px;opacity:0;pointer-events:none}
  .toast.show{opacity:1;transition:opacity .25s}
  @media(max-width:420px){ .score{font-size:34px} header{gap:8px} .logo{width:48px;height:48px;font-size:16px}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">CL</div>
    <div>
      <h1>Clicker v2</h1>
      <div class="muted small">Нажимай на кнопку, покупай автоматизацию и улучшения. Прогресс сохраняется автоматически.</div>
    </div>
  </header>

  <div class="row">
    <div class="card" style="flex:0 0 48%;">
      <div class="muted small">Монеты</div>
      <div id="score" class="score">0</div>
      <div style="text-align:center">
        <button id="clickBtn" class="btn" style="width:86%;">Клик!</button>
      </div>

              <div style="display:flex;justify-content:center;margin-top:10px;gap:8px">
        <button id="saveBtn" class="secondary">Сохранить</button>
        <button id="resetBtn" class="secondary" title="Сброс прогресса">Сброс</button>
      </div>
    </div>

    <div class="card" style="flex:0 0 48%;">
      <div class="muted small">Магазин</div>

      <div id="shop">
        <!-- items injected by JS -->
      </div>

      <div style="margin-top:12px" class="muted small">Доход в секунду: <span id="cps">0</span></div>
    </div>
  </div>

  <footer>
    <div class="muted small">Версия 2 — локально на устройстве</div>
    <div class="muted small">Сохранено: <span id="savedAt">—</span></div>
  </footer>
</div>

<div id="toast" class="toast"></div>

<script>
(function(){
  // state
  let state = {
    score: 0,
    cps: 0, // coins per second
    items: [
      { id:'auto1', name:'Авто-кликер I', baseCost:25, cps:0.5, count:0 },
      { id:'auto2', name:'Авто-кликер II', baseCost:150, cps:3, count:0 },
      { id:'upgrade', name:'Улучшение клика', baseCost:50, multiplier:2, count:0 }
    ],
    clickPower: 1
  };

  // ui elements
  const scoreEl = document.getElementById('score');
  const clickBtn = document.getElementById('clickBtn');
  const shopEl = document.getElementById('shop');
  const cpsEl = document.getElementById('cps');
  const savedAtEl = document.getElementById('savedAt');
  const toastEl = document.getElementById('toast');
  const saveBtn = document.getElementById('saveBtn');
  const resetBtn = document.getElementById('resetBtn');

  // helpers
  function format(n){ return Math.floor(n); }
  function costFor(item){ return Math.ceil(item.baseCost * Math.pow(1.15, item.count)); }

    <textarea id="saveArea" class="exportarea" placeholder="Вставьте сюда JSON для импорта"></textarea>
</div>

<script>
/* ====== Балансы и шаблоны (Casual / Normal / Hardcore) ====== */
const BALANCES = {
  casual: {
    PRESTIGE_THRESHOLD: 4000,
    templates: [
      { id:'hand',   name:'Рука',       desc:'+1 к клику',   type:'click', baseCost:6,    baseGain:1,  costMult:1.10, unlock:0, prereq:null },
      { id:'brush',  name:'Щётка',      desc:'+5 к клику',   type:'click', baseCost:30,   baseGain:5,  costMult:1.12, unlock:30, prereq:null },
      { id:'auto1',  name:'Машина',     desc:'+1 CPS',       type:'cps',   baseCost:12,   baseGain:1,  costMult:1.11, unlock:10, prereq:null },
      { id:'auto2',  name:'Фабрика',    desc:'+8 CPS',       type:'cps',   baseCost:180,  baseGain:8,  costMult:1.12, unlock:200, prereq:{id:'auto1', level:4} },
      { id:'auto3',  name:'Завод',      desc:'+60 CPS',      type:'cps',   baseCost:1800, baseGain:60, costMult:1.13, unlock:1200, prereq:{id:'auto2', level:6} },
      { id:'mega',   name:'Мегаручка',  desc:'x2 сила клика', type:'mult', baseCost:800, baseGain:2, costMult:1.6, unlock:600, prereq:{id:'brush', level:3} },
      { id:'hyper',  name:'Гиперрука',  desc:'x3 сила клика', type:'mult', baseCost:4200, baseGain:3, costMult:1.8, unlock:3000, prereq:[{id:'mega', level:2},{id:'auto2', level:4}] },
      { id:'lab',    name:'Лаборатория', desc:'+180 CPS', type:'cps', baseCost:25000, baseGain:180, costMult:1.14, unlock:12000, prereq:[{id:'auto3', level:2},{id:'mega', level:2}] },
      { id:'quant',  name:'Квантовый узел', desc:'+x (комбо)', type:'mult', baseCost:120000, baseGain:4, costMult:2.0, unlock:80000, prereq:[{id:'lab', level:1},{id:'hyper', level:1}] },
      { id:'plant',  name:'Энергоплантация', desc:'+800 CPS', type:'cps', baseCost:600000, baseGain:800, costMult:1.12, unlock:400000, prereq:[{id:'lab', level:3},{id:'auto3', level:8}] },
    ]
  },
  normal: {
    PRESTIGE_THRESHOLD: 10000,
    templates: [
      { id:'hand',   name:'Рука',       desc:'+1 к клику',   type:'click', baseCost:8,    baseGain:1,  costMult:1.12, unlock:0, prereq:null },
      { id:'brush',  name:'Щётка',      desc:'+4 к клику',   type:'click', baseCost:55,   baseGain:4,  costMult:1.14, unlock:50, prereq:null },
      { id:'auto1',  name:'Машина',     desc:'+1 CPS',       type:'cps',   baseCost:18,   baseGain:1,  costMult:1.12, unlock:20, prereq:null },
      { id:'auto2',  name:'Фабрика',    desc:'+6 CPS',       type:'cps',   baseCost:380,  baseGain:6,  costMult:1.13, unlock:200, prereq:{id:'auto1', level:5} },
      { id:'auto3',  name:'Завод',      desc:'+40 CPS',      type:'cps',   baseCost:5400, baseGain:40, costMult:1.14, unlock:2000, prereq:{id:'auto2', level:10} },
      { id:'mega',   name:'Мегаручка',  desc:'x2 сила клика', type:'mult', baseCost:1800, baseGain:2, costMult:1.8, unlock:1000, prereq:{id:'brush', level:5} },
      { id:'hyper',  name:'Гиперрука',  desc:'x3 сила клика', type:'mult', baseCost:12000, baseGain:3, costMult:2.0, unlock:10000, prereq:[{id:'mega', level:2},{id:'auto2', level:5}] },
      { id:'lab',    name:'Лаборатория', desc:'+200 CPS', type:'cps', baseCost:80000, baseGain:200, costMult:1.16, unlock:50000, prereq:[{id:'auto3', level:2},{id:'mega', level:3}] },
      { id:'quant',  name:'Квантовый узел', desc:'+x (комбо)', type:'mult', baseCost:800000, baseGain:4, costMult:2.5, unlock:500000, prereq:[{id:'lab', level:1},{id:'hyper', level:1}] },
      { id:'plant',  name:'Энергоплантация', desc:'+1000 CPS', type:'cps', baseCost:2500000, baseGain:1000, costMult:1.15, unlock:2000000, prereq:[{id:'lab', level:3},{id:'auto3', level:10}] },
    ]
  },
  hardcore: {
    PRESTIGE_THRESHOLD: 30000,
    templates: [
      { id:'hand',   name:'Рука',       desc:'+1 к клику',   type:'click', baseCost:12,    baseGain:1,  costMult:1.14, unlock:0, prereq:null },
      { id:'brush',  name:'Щётка',      desc:'+3 к клику',   type:'click', baseCost:120,   baseGain:3,  costMult:1.16, unlock:120, prereq:null },
      { id:'auto1',  name:'Машина',     desc:'+1 CPS',       type:'cps',   baseCost:35,   baseGain:1,  costMult:1.14, unlock:40, prereq:null },
      { id:'auto2',  name:'Фабрика',    desc:'+5 CPS',       type:'cps',   baseCost:780,  baseGain:5,  costMult:1.15, unlock:600, prereq:{id:'auto1', level:6} },
      { id:'auto3',  name:'Завод',      desc:'+30 CPS',      type:'cps',   baseCost:12000, baseGain:30, costMult:1.16, unlock:7000, prereq:{id:'auto2', level:12} },
      { id:'mega',   name:'Мегаручка',  desc:'x2 сила клика', type:'mult', baseCost:6000, baseGain:2, costMult:2.0, unlock:4000, prereq:{id:'brush', level:6} },
      { id:'hyper',  name:'Гиперрука',  desc:'x3 сила клика', type:'mult', baseCost:48000, baseGain:3, costMult:2.4, unlock:40000, prereq:[{id:'mega', level:3},{id:'auto2', level:8}] },
      { id:'lab',    name:'Лаборатория', desc:'+140 CPS', type:'cps', baseCost:220000, baseGain:140, costMult:1.18, unlock:120000, prereq:[{id:'auto3', level:3},{id:'mega', level:4}] },
      { id:'quant',  name:'Квантовый узел', desc:'+x (комбо)', type:'mult', baseCost:1200000, baseGain:4, costMult:3.0, unlock:900000, prereq:[{id:'lab', level:1},{id:'hyper', level:1}] },
      { id:'plant',  name:'Энергоплантация', desc:'+700 CPS', type:'cps', baseCost:8000000, baseGain:700, costMult:1.18, unlock:5000000, prereq:[{id:'lab', level:4},{id:'auto3', level:14}] },
    ]
  }
};

/* ====== Игровое состояние и вспомогательные функции ====== */
let PRESTIGE_THRESHOLD = 10000;
let upgradeTemplates = []; // текущие шаблоны
let upgrades = []; // объекты (id,name,desc,type,baseCost,baseGain,costMult,unlock,prereq, level, cost)
let coins = 0;
let totalCPS = 0;
let clickPower = 1;
const STORAGE_KEY = 'simpleClickerSave_v2';

/* более "гладкая" формула стоимости:
   price(level) = floor(baseCost * costMult^level * (1 + level * 0.02))
   Это даёт немного растущую надбавку к экспоненте (чтобы large-level не становились слишком дешёвыми)
*/
function calcCost(template, level){
  return Math.max(1, Math.floor(template.baseCost * Math.pow(template.costMult, level) * (1 + level * 0.02)));
}

/* сумма стоимости покупки n уровней от текущего level */
function sumCostForN(template, startLevel, n){
  let sum = 0;
  for (let i = 0; i < n; i++){
    sum += calcCost(template, startLevel + i);
  }
  return sum;
}

/* вычисляет максимально возможное количество покупок для данного апгрейда с текущими монетами */
function maxAffordable(template, startLevel, availableCoins){
  let count = 0;
  // быстрый проход: экспоненциально увеличиваем шагы
  let step = 1;
  while (true){
    const cost = sumCostForN(template, startLevel + count, step);
    if (cost <= availableCoins){
      count += step;
      step *= 2;
    } else {
      if (step === 1) break;
      step = Math.max(1, Math.floor(step/2));
    }
  }
  return count;
}

/* инициализация апгрейдов — сохраняет уровни, если id совпадает с прошлым состоянием */
function initUpgrades(preservedLevels = {}){
  upgrades = upgradeTemplates.map(t => {
    const level = preservedLevels[t.id] || 0;
    return {
      ...t,
      level: level,
      cost: calcCost(t, level)
    };
  });
}

/* подсчет CPS и силы клика на основе уровней апгрейдов */
function recalcDerived(){
  totalCPS = 0;
  clickPower = 1;
  for (const u of upgrades){
    if (u.level <= 0) continue;
    if (u.type === 'cps'){
      // учитываем возможный мультипликатор от mult-апгрейдов (если потребуется)
      totalCPS += u.baseGain * u.level;
    } else if (u.type === 'click'){
      clickPower += u.baseGain * u.level;
    } else if (u.type === 'mult'){
      // мультипликатор силы клика: baseGain ^ level
      clickPower *= Math.pow(u.baseGain, u.level);
    }
  }
}

/* рендер UI */
function render(){
  document.getElementById('coins').textContent = formatNumber(coins);
  document.getElementById('cps').textContent = (totalCPS).toFixed(1);
  document.getElementById('clickPower').textContent = formatNumber(clickPower);
  document.getElementById('prestigeThreshold').textContent = PRESTIGE_THRESHOLD;

    const percent = Math.min(100, Math.floor((coins / PRESTIGE_THRESHOLD) * 100));
  document.getElementById('prestigeBar').style.width = percent + '%';
  document.getElementById('coinsForPrestige').textContent = formatNumber(coins);
  document.getElementById('prestigeThreshold2').textContent = formatNumber(PRESTIGE_THRESHOLD);
  document.getElementById('prestigePercent').textContent = percent;

  const list = document.getElementById('upgradesList');
  list.innerHTML = '';
  for (const u of upgrades){
    // проверим доступность (по unlock и prereq)
    let locked = false;
    if ((u.unlock || 0) > coins) locked = true;
    if (u.prereq){
      const reqs = Array.isArray(u.prereq) ? u.prereq : [u.prereq];
      for (const r of reqs){
        const found = upgrades.find(x => x.id === r.id);
        if (!found || (found.level || 0) < (r.level || 0)) { locked = true; break; }
      }
    }

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = 
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${escapeHtml(u.name)}</strong>
        <div class="muted">${u.type.toUpperCase()}</div>
      </div>
      <div class="muted" style="margin:6px 0">${escapeHtml(u.desc)}</div>
      <div>Уровень: <strong>${u.level}</strong></div>
      <div class="muted">Цена следующего: <strong>${formatNumber(u.cost)}</strong></div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button ${locked ? 'disabled' : ''} data-id="${u.id}" class="buyOne compact">Купить</button>
        <button ${locked ? 'disabled' : ''} data-id="${u.id}" data-bulk="10" class="buyBulk compact">Купить x10</button>
        <button ${locked ? 'disabled' : ''} data-id="${u.id}" data-bulk="100" class="buyBulk compact">Купить x100</button>
        <button ${locked ? 'disabled' : ''} data-id="${u.id}" data-bulk="max" class="buyBulk compact">Купить MAX</button>
      </div>
    ;
    list.appendChild(card);
  }

  // вешаем обработчики покупки
  list.querySelectorAll('button.buyOne').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-id');
      buyUpgrade(id, 1);
    });
  });
  list.querySelectorAll('button.buyBulk').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-id');
      const bulk = btn.getAttribute('data-bulk');
      if (bulk === 'max') buyUpgradeMax(id);
      else buyUpgrade(id, parseInt(bulk,10));
    });
  });
}

/* покупка апгрейда (n уровней) */
function buyUpgrade(id, n){
  const u = upgrades.find(x=>x.id===id);
  if (!u) return;
  if (n <= 0) return;
  // проверка блокировок (unlock + prereq)
  if ((u.unlock || 0) > coins) { alert('Апгрейд пока недоступен (unlock)'); return; }
  if (u.prereq){
    const reqs = Array.isArray(u.prereq) ? u.prereq : [u.prereq];
    for (const r of reqs){
      const found = upgrades.find(x => x.id === r.id);
      if (!found || (found.level || 0) < (r.level || 0)) { alert('Апгрейд недоступен (требуется другой апгрейд)'); return; }
    }
  }
  // подсчитать суммарную цену n уровней
  const cost = sumCostForN(u, u.level, n);
  if (coins < cost) { alert('Недостаточно монет'); return; }
  coins -= cost;
  u.level += n;
  u.cost = calcCost(u, u.level);
  recalcDerived();
  saveGame();
  render();
}

/* покупка макс возможного */
function buyUpgradeMax(id){
  const u = upgrades.find(x=>x.id===id);
  if (!u) return;
  if ((u.unlock || 0) > coins) { alert('Апгрейд пока недоступен (unlock)'); return; }
  if (u.prereq){
    const reqs = Array.isArray(u.prereq) ? u.prereq : [u.prereq];
    for (const r of reqs){
      const found = upgrades.find(x => x.id === r.id);
      if (!found || (found.level || 0) < (r.level || 0)) { alert('Апгрейд недоступен (требуется другой апгрейд)'); return; }
    }
  }
  const maxCount = maxAffordable(u, u.level, coins);
  if (maxCount <= 0){ alert('Невозможно купить ни одного уровня'); return; }
  const cost = sumCostForN(u, u.level, maxCount);
  coins -= cost;
  u.level += maxCount;

    u.cost = calcCost(u, u.level);
  recalcDerived();
  saveGame();
  render();
}

/* кликанье */
function doClick(){
  coins += clickPower;
  render();
}

/* авто-накопление CPS (каждую секунду) */
setInterval(()=>{
  coins += totalCPS;
  render();
}, 1000);

/* сохранение/загрузка */
function saveGame(){
  const data = {
    coins: coins,
    preset: document.getElementById('balancePreset').value,
    upgrades: upgrades.map(u=>({id:u.id, level:u.level})),
    prestigeThreshold: PRESTIGE_THRESHOLD,
    ts: Date.now()
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  return data;
}

function loadGame(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return null;
  try{ return JSON.parse(raw); }catch(e){ return null; }
}

/* вспомогательные: формат числа, экранирование */
function formatNumber(x){
  if (Math.abs(x) >= 1000000) return Math.round(x).toLocaleString();
  return (Math.round(x*100)/100).toString();
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ====== Применение пресета и логика смены баланса ====== */
function applyBalance(preset){
  const b = BALANCES[preset] || BALANCES.normal;
  const preservedLevels = {};
  for (const u of upgrades) preservedLevels[u.id] = u.level || 0;

  PRESTIGE_THRESHOLD = b.PRESTIGE_THRESHOLD;
  upgradeTemplates = b.templates.map(t => ({ ...t }));
  initUpgrades(preservedLevels);
  recalcDerived();
  saveGame();
  render();
}

/* обработчик смены в селекте */
document.getElementById('balancePreset').addEventListener('change', (e)=>{
  if (!confirm('Сменить баланс? Уровни апгрейдов будут сохранены по id.')) {
    const saved = loadGame();
    if (saved && saved.preset) document.getElementById('balancePreset').value = saved.preset;
    return;
  }
  applyBalance(e.target.value);
});

/* кнопки */
document.getElementById('clickBtn').addEventListener('click', ()=>{ doClick(); });
document.getElementById('saveBtn').addEventListener('click', ()=>{ saveGame(); alert('Сохранено'); });
document.getElementById('resetBtn').addEventListener('click', ()=>{
  if (!confirm('Сбросить прогресс?')) return;
  localStorage.removeItem(STORAGE_KEY);
  coins = 0;
  upgrades.forEach(u=>{ u.level = 0; u.cost = calcCost(u, 0); });
  recalcDerived();
  saveGame();
  render();
});

/* экспорт/импорт */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const data = saveGame();
  document.getElementById('saveArea').value = JSON.stringify(data, null, 2);
  alert('JSON с сохранением размещён в поле ниже. Скопируйте его для резервной копии.');
});
document.getElementById('importBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('saveArea').value.trim();
  if (!txt){ alert('Поле пустое'); return; }
  try{
    const obj = JSON.parse(txt);
    // небольшая валидация
    if (!obj.preset || !BALANCES[obj.preset]) { if (!confirm('Пресет в JSON не распознан — применить default?')) return; }
    // применяем пресет (или текущий), затем уровни
    const preset = (obj.preset && BALANCES[obj.preset]) ? obj.preset : document.getElementById('balancePreset').value;
    document.getElementById('balancePreset').value = preset;
    applyBalance(preset);
    if (Array.isArray(obj.upgrades)){
      const levels = {};
      for (const s of obj.upgrades) levels[s.id] = s.level || 0;
      initUpgrades(levels);
      recalcDerived();
    }
    coins = obj.coins || coins;
    saveGame();
    render();
    alert('Импорт завершён');
  }catch(e){
    alert('Ошибка парсинга JSON: ' + e.message);
  }
});
document.getElementById('clearSaveBtn').addEventListener('click', ()=>{
  if (!confirm('Удалить локальное сохранение?')) return;
  localStorage.removeItem(STORAGE_KEY);
  alert('Локальное сохранение удалено.');
});

/* стартовая загрузка */
(function start(){
  const saved = loadGame();
  if (saved && saved.preset && BALANCES[saved.preset]){
    document.getElementById('balancePreset').value = saved.preset;
    applyBalance(saved.preset);
    if (saved.upgrades){
            const levels = {};
      for (const s of saved.upgrades) levels[s.id] = s.level || 0;
      initUpgrades(levels);
      recalcDerived();
    }
    coins = saved.coins || 0;
  } else {
    document.getElementById('balancePreset').value = 'casual';
    applyBalance('casual');
    coins = 20;
  }
  render();
})();
</script>
</body>
</html>
  
